# Repo Architecture — habeas_patches

## What Is This Repo?

`clovenbradshaw-ctrl/habeas_patches` is the **active development repo** for the Amino Habeas app. This is where Claude Code and developers push changes. The live app at `app.aminoimmigration.com` is served from GitHub Pages out of this repo, but **not every merge goes live automatically** — an admin must review and explicitly trigger a deploy.

Think of it this way:

```
Developer / Claude Code
        │
        │  push feature branch / PR
        ▼
  habeas_patches (this repo)
        │
        │  commits accumulate on main
        │  (NOT auto-deployed)
        ▼
  Admin logs into app
  sees "Deploy" panel (admin only)
        │
        │  reviews diff, approves
        │  clicks "Deploy to Production"
        ▼
  GitHub Actions → builds deploy-info.js → pushes to gh-pages
        │
        ▼
  app.aminoimmigration.com  ← users see the update
```

---

## Two-Repo Concept

The user-facing experience is a **single URL** (`app.aminoimmigration.com`), but there are two logical states:

| State | What it is |
|---|---|
| **main branch** | Latest merged code — may not be live yet |
| **gh-pages / deployed** | What users actually see right now |

The gap between them is intentional. Merging to `main` does not automatically push to users. The admin controls when the live app advances.

### Why not auto-deploy?

- Updates to an immigration case management app need human sign-off before reaching attorneys
- Admin can preview changes in **dev mode** (see below) before pushing live
- Easy rollback: admin can redeploy any prior commit via the same panel

---

## Files in This Repo

```
habeas_patches/
├── index.html          ← Static bootstrap. Loads scripts. Rarely changes.
├── app.js              ← Entire application (~6700 lines, vanilla JS, no build step)
├── styles.css          ← All styles
├── deploy-info.js      ← Injected at deploy time — never edit by hand (see below)
├── courts.json         ← Seed data for courts (used during initial setup)
├── facilities.json     ← Seed data for facilities (used during initial setup)
├── template.html       ← Petition document template
├── favicon.svg         ← App icon
├── CLAUDE.md           ← Full system architecture (Matrix rooms, data model, etc.)
└── REPO_ARCHITECTURE.md  ← This file
```

**`index.html` is the only truly static file** — it can't be changed by Matrix or runtime config. Keep it minimal: it's just a loader for `app.js`, `styles.css`, and `deploy-info.js`.

**`app.js` is the whole app.** There's no build step, no npm, no React. It's vanilla JS that calls the Matrix REST API directly. To understand the data model, read `CLAUDE.md`.

---

## deploy-info.js

This file is **auto-generated by GitHub Actions** at deploy time. Never edit it by hand in a feature branch — it will be overwritten.

```js
// Injected by CI — do not edit manually
var DEPLOY_INFO = {
  sha: "abc1234...",       // full commit SHA
  shortSha: "abc1234",     // 7-char abbreviated SHA
  timestamp: "2026-...",   // ISO deploy timestamp
  message: "Fix petition export", // commit message
  author: "clovenbradshaw-ctrl",
  prNumber: "42",          // PR number if deployed from a PR
  env: "production",       // "production" | "development"
  repo: "clovenbradshaw-ctrl/habeas_patches",
};
```

In local development (running the files directly), `deploy-info.js` has `env: "development"` and `sha: "local"`. The app detects this and shows a **DEV badge** (see below).

---

## Admin Deploy Panel

The deploy panel lives at **Admin → Deploy** and is only visible to users with `role: "admin"`.

It connects to the GitHub API using a **Personal Access Token** stored in the Matrix `!org` room as a state event. This means the token is shared across all admin sessions automatically — one admin saves it once and all admins can use the deploy panel.

### Deploy panel capabilities

1. **View pending commits** — commits merged to `main` that haven't been deployed yet
2. **Review diff** — see file-by-file changes between production SHA and latest `main`
3. **Approve + Deploy** — trigger the `deploy.yml` GitHub Actions workflow for a specific SHA
4. **Rollback** — trigger the `rollback.yml` workflow to redeploy any prior commit

### Workflow trigger flow

```
Admin clicks "Deploy to Production"
    │
    ▼
app.js → POST /repos/habeas_patches/actions/workflows/deploy.yml/dispatches
    │     { ref: "main", inputs: { target_sha: "abc1234" } }
    ▼
GitHub Actions runs deploy.yml
    │  - checks out target_sha
    │  - generates deploy-info.js with env: "production"
    │  - copies files to gh-pages branch
    ▼
GitHub Pages serves updated files
    ▼
Users see the new version on next page load
```

---

## Dev Mode (DEV Badge)

When the running app's `DEPLOY_INFO.env` is not `"production"` — which is the case for:
- Local file:// development
- Any deployment where GitHub Actions didn't inject the deploy-info

...the app shows a **DEV badge** in the navigation. This badge is visible to all logged-in users (not just admins), so attorneys know they're on a non-production instance.

The deploy panel also shows a warning banner in dev mode reminding admins that changes won't reach users until a deploy is triggered.

---

## How Matrix Stores Configuration

All runtime configuration (who can deploy, what GitHub token to use, directory data) lives in the Matrix `!org` room, **not** in this repo. This means:

- Updating the GitHub PAT doesn't require a code push — admin saves it in the deploy panel once, it syncs to all logged-in sessions via Matrix
- Directory data (facilities, courts, attorneys) is in Matrix state, not in these files
- `courts.json` and `facilities.json` in this repo are **seed data** for initial setup only — they are not read by the live app

The one exception: `CONFIG` at the top of `app.js` hardcodes the Matrix server URL and org room alias. Changing homeservers requires a code change.

---

## How to Work in This Repo

### For Claude Code / developers

1. **Branch from `main`** — name branches descriptively (e.g., `fix/petition-export-date`, `feat/template-picker`)
2. **Edit `app.js` and/or `styles.css`** — no build step needed
3. **Open a PR to `main`** — describe what changed and why
4. **Merge to `main`** — this does NOT go live yet
5. Admin reviews and deploys when ready

### Branch naming (Claude Code sessions)

Claude Code branches follow the pattern: `claude/<description>-<sessionId>`

These are the branches Claude Code works on during an active session. They should be reviewed and merged by a human before the admin deploys.

### Never do this

- Don't edit `deploy-info.js` — it's overwritten by CI
- Don't push directly to `gh-pages` — the GitHub Actions workflow manages that
- Don't auto-merge to `main` without a PR review for substantial changes
- Don't store secrets (PAT tokens, passwords) in this repo — they go in Matrix state

---

## GitHub Actions Workflows

Two workflows are expected in `.github/workflows/`:

| Workflow | Trigger | What it does |
|---|---|---|
| `deploy.yml` | `workflow_dispatch` (manual) | Checks out `target_sha`, injects `deploy-info.js` with `env: production`, deploys to `gh-pages` |
| `rollback.yml` | `workflow_dispatch` (manual) | Same as deploy but for a prior SHA — effectively a redeploy |

**Important:** GitHub Pages must be set to **Source = GitHub Actions** (not "Deploy from a branch"). If it's set to "Deploy from a branch", every push to `main` would auto-deploy, bypassing the admin review gate.

---

## Summary: The Intended Flow

```
Claude Code (or dev) → commits to feature branch → PR → merge to main
                                                              │
                                          (no auto-deploy)   │
                                                              ▼
                                              Admin opens Deploy panel
                                              reviews diff of pending commits
                                              clicks "Deploy to Production"
                                                              │
                                                              ▼
                                              GitHub Actions → gh-pages
                                                              │
                                                              ▼
                                              Users see update on next load
```

The Matrix `!org` room ties it together: it stores the GitHub PAT (so the deploy panel works across sessions), user roles (so only admins see the deploy panel), and all directory/case data (so none of that lives in this repo).
